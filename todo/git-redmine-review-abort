#!/bin/bash

source /usr/local/share/Git-Redmine-Suite/helpers/current_git_command
function help {
    echo "$CURRENT_GIT_COMMAND"
    exit 1
}

if [ -n "$HELP" ]
then
    help
fi

set -e

source /usr/local/share/Git-Redmine-Suite/helpers/redmine-checkconf
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-statuses
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-question

set +e

TASK=$(git config redmine.review.current)

if [ -z "$TASK" ]
then
    echo "You have not start any review !"
    exit 1
fi

set -e

TASK_TITLE=$(git config "redmine.review.$TASK.title")
BRNAME=$(git config "redmine.review.$TASK.branch")

are_you_sure "Aborting the review of # $TASK_TITLE - PR:$PR ?"

git checkout devel
git branch -D "$BRNAME"
git config --remove-section "redmine.review.$TASK"

echo ""
echo "Updating redmine status ..."
task=$TASK \
status=$REDMINE_REVIEW_TODO \
assigned_to=$REDMINE_USER_ID \
redmine_set_status
echo ""
