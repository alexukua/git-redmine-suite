#!/bin/bash

source /usr/local/share/Git-Redmine-Suite/helpers/current_git_command
function help {
    echo "[V=X.XX] $CURRENT_GIT_COMMAND TASK_1 TASK_2 ..."
    exit 1
}

if [ "x$HELP" != "x" ]
then
    help
fi

set -e

source /usr/local/share/Git-Redmine-Suite/helpers/redmine-checkconf
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-project
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-tasks
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-statuses
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-question

if git config "redmine.release.simple.version" > /dev/null
then
    echo "Your already has start a release !"
    echo "Please abort it or finish it :"
    echo ""
    echo "    git redmine release simple abort"
    echo "    git redmine release simple finish"
    echo ""
    exit 1
fi


declare -a TASKS=($*)

if [ ${#TASKS[@]} -eq 0 ]
then
    echo "Please list the tasks you want to release :"
    TASKS=""
    for REDMINE_PROJECT in $(redmine_get_all_active_projects)
    do
        echo "[$REDMINE_PROJECT]"
        echo ""
        /usr/local/share/Git-Redmine-Suite/helpers/redmine-get-tasks --auth_key="$REDMINE_AUTHKEY" --server_url="$REDMINE_URL" --project="$REDMINE_PROJECT" --assigned_to_id="$REDMINE_USER_ID" --status_id="$REDMINE_RELEASE_TODO"
        ADD_TASKS=$(/usr/local/share/Git-Redmine-Suite/helpers/redmine-get-tasks --auth_key="$REDMINE_AUTHKEY" --server_url="$REDMINE_URL" --project="$REDMINE_PROJECT" --assigned_to_id="$REDMINE_USER_ID" --status_id="$REDMINE_RELEASE_TODO" --ids_only)
        if [ "x$ADD_TASKS" != "x" ]
        then
            if [ "x$TASKS" == "x" ]
            then
                TASKS="$ADD_TASKS"
            else
                TASKS="$TASKS $ADD_TASKS"
            fi
        fi
    done
    if [ "x$TASKS" != "x" ]
    then
        echo ""
        echo "If you want to release everything, you can run :"
        echo ""
        echo "    $CURRENT_GIT_COMMAND $TASKS"
        echo ""
    fi

    exit 1
fi

for TASK in ${TASKS[@]}
do
    echo "Check redmine status $TASK ..."
    redmine_check_task "$TASK" "$REDMINE_RELEASE_TODO,$REDMINE_RELEASE_FINISH"
done

git fetch -ap
git fetch --tags -p

if [ "x$V" == "x" ]
then
    V=$(/usr/local/share/Git-Redmine-Suite/helpers/next_version --version=$(((git tag | grep ^v) || echo "v0.00") | /usr/bin/perl -pe 's/^v//' | sort -n | tail -n1))
fi

Q="Start release v$V"
if [ "x$GIT_REDMINE_CHAIN_RELEASE_START" == "x1" ]
then
    echo "$Q ..."
else
    are_you_sure "$Q ?"
fi

BRNAME="redmine-release-v$V"

git checkout devel
git merge origin/devel
git checkout -b "$BRNAME"

git config "redmine.release.simple.version" "$V"
git config "redmine.release.simple.tasks" "$(echo ${TASKS[@]})"
git config "redmine.release.simple.branch" "$BRNAME"

for TASK in ${TASKS[@]}
do
    echo "Update redmine status $TASK ..."
    task=$TASK \
    status=$REDMINE_RELEASE_TODO \
    assigned_to=$REDMINE_USER_ID \
    redmine_set_status
done

CHANGELOG=$(get_change_log)
touch "$CHANGELOG"

/usr/local/share/Git-Redmine-Suite/helpers/tag_version --version="$V" > "$CHANGELOG".new
cat "$CHANGELOG" >> "$CHANGELOG".new
mv "$CHANGELOG".new "$CHANGELOG"
vim "$CHANGELOG" || true
git add "$CHANGELOG"
git ci -m "Add version in Changes"
if [ -e 'dist.ini' ]
then
    cat dist.ini | /usr/bin/perl -pe "s/version = (.*)/version = $V/" > dist.ini.new
    mv dist.ini.new dist.ini
    vim dist.ini || true
    git add dist.ini
    git ci -m 'Update version DistZilla'
fi
if [ -e 'VERSION' ]
then
    echo "$V" > VERSION
    git add VERSION
    git ci -m 'Update version file'
fi

set +x
git diff --color origin/master | less -R
cat <<__EOF__
Please edit all the file you need and commit it before finish the release.
Don't forget to run the tests !

You can finish with :

git redmine release simple finish

or you can abort :

git redmine release simple abort

__EOF__

if are_you_sure "Do you want to finish the release now ?"
then
    GIT_REDMINE_CHAIN_RELEASE_FINISH=1 exec git redmine release simple finish
fi