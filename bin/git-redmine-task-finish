#!/bin/bash

function help {
    echo "git redmine task finish TASK_NUMBER"
    exit 1
}

TASK="$1"

if [ "x$TASK" == "x" ]
then
    help
fi

source /usr/local/share/Git-Redmine-Suite/helpers/redmine-checkconf
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-statuses
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-project

set -e

TASK_TITLE=$(git config redmine.task.$TASK.title)
BRNAME=$(git config redmine.task.$TASK.branch)
PROJECT=$(git config redmine.task.$TASK.project)
set +e
TASK_FINISH_USER_ID=$(git config redmine.project.$PROJECT.finish.user.id.task)
if [ "x$TASK_FINISH_USER_ID" == "x" ]
then
    redmine_get_project_users "$PROJECT"
    exit 1
fi

D=$(date -u +%Y%m%d%H%M%S)
TAG="pr-$D-$BRNAME"

set -e

echo "Pushing local on origin ..."

set -x

git fetch -ap
git fetch --tags -p
git checkout "$BRNAME"
git push origin "$BRNAME"
git tag "$TAG"
git push origin tags/"$TAG"
git checkout devel
git merge origin/devel

set +x

echo ""
echo "Updating redmine status ..."

REMOTE_URL=$(git config remote.origin.url)
DEPS=$((git config redmine.task.$TASK.depends || true) | perl -pe 's/(\d+)/#$1/g')
MSG_DEPS=""
if [ "x$DEPS" != "x" ]
then
    MSG_DEPS="Before reviewing this task, ensure you have already review : $DEPS"
fi

redmine_set_status $TASK $REDMINE_REVIEW_TODO $TASK_FINISH_USER_ID "
* REMOTE : $REMOTE_URL
* PR: $TAG

You can start a review with :
<pre>
git redmine review start $TASK $TAG
</pre>

$MSG_DEPS
"
echo ""
