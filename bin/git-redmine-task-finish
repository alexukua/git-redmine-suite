#!/bin/bash

source /usr/local/share/Git-Redmine-Suite/helpers/current_git_command
function help {
    echo "$CURRENT_GIT_COMMAND"
    exit 1
}

if [ "x$HELP" != "x" ]
then
    help
fi

set -e

source /usr/local/share/Git-Redmine-Suite/helpers/redmine-checkconf
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-statuses
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-project
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-tasks
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-question

set +e

TASK=$(git config redmine.task.current)

if [ "x$TASK" == "x" ]
then
    echo "You have not start any task !"
    exit 1
fi

set -e

redmine_check_task "$TASK" "$REDMINE_TASK_IN_PROGRESS"

TASK_TITLE=$(git config redmine.task.$TASK.title)
are_you_sure "Do you really want to finish $TASK_TITLE ?"

BRNAME=$(git config redmine.task.$TASK.branch)
PROJECT=$(git config redmine.task.$TASK.project)
set +e
TASK_FINISH_USER_ID=$(git config redmine.project.$PROJECT.finish.user.id.task)
if [ "x$TASK_FINISH_USER_ID" == "x" ]
then
    redmine_get_project_users "$PROJECT"
    exit 1
fi

D=$(date -u +%Y%m%d%H%M%S)
TAG="pr-$D-$BRNAME"

set -e

echo "Pushing local on origin ..."

git fetch -ap
git fetch --tags -p
git checkout "$BRNAME"
git push origin "$BRNAME"
git tag "$TAG"
git push origin tags/"$TAG"
git checkout devel
git merge origin/devel
git config --unset "redmine.task.current"

echo ""
echo "Updating redmine status ..."

REMOTE_URL=$(git config remote.origin.url)
DEPS=$((git config redmine.task.$TASK.depends || true) | perl -pe 's/(\d+)/#$1/g')
MSG_DEPS=""
if [ "x$DEPS" != "x" ]
then
    MSG_DEPS="Before reviewing this task, ensure you have already review : $DEPS"
fi

F=$(mktemp /tmp/redmine.XXXXXX)
vim "$F"

redmine_set_status $TASK $REDMINE_REVIEW_TODO $TASK_FINISH_USER_ID "
* REMOTE : $REMOTE_URL
* PR: $TAG

You can start a review with :
<pre>
git redmine review start $TASK $TAG
</pre>

$MSG_DEPS

Additional comments from the developer :

$(cat "$F")
"
echo ""
unlink "$F"

if [ "x$TASK_FINISH_USER_ID" == "x$REDMINE_USER_ID" ]
then
	if are_you_sure "You are the reviewer of this task. Do you want to review now ?"
	then
		GIT_REDMINE_CHAIN_REVIEW_START=1 exec git redmine review start $TASK $TAG
	fi
fi
