#!/bin/bash

source /usr/local/share/Git-Redmine-Suite/helpers/current_git_command
function help {
    echo "$CURRENT_GIT_COMMAND"
    exit 1
}

if [ "x$HELP" != "x" ]
then
    help
fi

set -e

source /usr/local/share/Git-Redmine-Suite/helpers/redmine-checkconf
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-project
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-tasks
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-statuses
source /usr/local/share/Git-Redmine-Suite/helpers/redmine-question

if ! git config "redmine.release.simple.version" > /dev/null
then
    echo "Your have no release in progress"
    echo ""
    exit 1
fi

declare -a TASKS=($(git config redmine.release.simple.tasks))

for TASK in ${TASKS[@]}
do
    echo "Check redmine status $TASK ..."
    redmine_check_task "$TASK" "$REDMINE_RELEASE_TODO"

    PROJECT=$(redmine_get_project $TASK)
    if ! git config redmine.project.$PROJECT.finish.user.id.release > /dev/null
    then
        redmine_get_project_users "$PROJECT"
        exit 1
    fi

done

V=$(git config redmine.release.simple.version)
BRNAME=$(git config redmine.release.simple.branch)

Q="Finish release v$V"
if [ "x$GIT_REDMINE_CHAIN_RELEASE_FINISH" == "x1" ]
then
    echo "$Q ..."
else
    are_you_sure "$Q ?"
fi

git fetch -ap
git fetch --tags -p
git checkout devel
git merge origin/devel
git merge --no-ff "$BRNAME" -m "Merge $BRNAME"
git push origin devel
git checkout master
git merge origin/master
git merge --no-ff devel -m "Merge $BRNAME"
git tag -m "release v$V: $(echo ${TASKS[@]})" "v$V"
git push origin master
git push origin "tags/v$V"
git branch -d $BRNAME
git config --remove-section redmine.release.simple

REMOTE_URL=$(git config remote.origin.url)
for TASK in ${TASKS[@]}
do
    echo "Update redmine status $TASK ..."
    PROJECT=$(redmine_get_project $TASK)
    RELEASE_FINISH_USER_ID=$(git config redmine.project.$PROJECT.finish.user.id.release)
    redmine_set_status $TASK $REDMINE_RELEASE_FINISH $RELEASE_FINISH_USER_ID "
* REMOTE : $REMOTE_URL
* RELEASED : v$V
"
done


